name: Manual Build and Deploy to EKS

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-west-2
  AWS_ACCOUNT_ID: 437670317444
  EKS_CLUSTER_NAME: vault-file-app-cluster

jobs:
  deploy_docker_images:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Authenticate to AWS via OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::437670317444:role/GitHubActionRole
          aws-region: ${{ env.AWS_REGION }}

      # 3. Login to Amazon ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Build & push FRONTEND image
      - name: Build and push frontend
        run: |
          FRONTEND_IMAGE=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/vault-app-repo-frontend:${{ github.sha }}
          docker build -t $FRONTEND_IMAGE ./src/public
          docker push $FRONTEND_IMAGE

      # 5. Build & push BACKEND image
      - name: Build and push backend
        run: |
          BACKEND_IMAGE=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/vault-app-repo-backend:${{ github.sha }}
          docker build -t $BACKEND_IMAGE ./src
          docker push $BACKEND_IMAGE
    
  deploy_kubernetes_resources:
    runs-on: ubuntu-latest
    needs: deploy_docker_images

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::437670317444:role/GitHubActionRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION

      - name: Apply ConfigMaps
        run: |
          kubectl apply -f k8s/configmaps/

      - name: Apply backend secrets
        run: |
          kubectl create secret generic backend-secrets \
            --from-literal=DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            --from-literal=JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Deployments
        run: |
          kubectl apply -f k8s/deployments/frontend-deployment.yml
          kubectl apply -f k8s/deployments/backend-deployment.yml

      - name: Update images to new ECR builds
        run: |
          kubectl set image deployment/vault-frontend \
            vault-frontend=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/vault-app-repo-frontend:${{ github.sha }}
          kubectl set image deployment/vault-backend \
            vault-backend=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/vault-app-repo-backend:${{ github.sha }}

      - name: Restart deployments
        run: |
          kubectl rollout restart deployment/vault-frontend
          kubectl rollout restart deployment/vault-backend

      - name: Verify rollout
        run: |
          kubectl rollout status deployment/vault-frontend
          kubectl rollout status deployment/vault-backend