name: Manual Build and Deploy to EKS

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-west-2
  AWS_ACCOUNT_ID: 437670317444
  EKS_CLUSTER_NAME: vault-file-app-cluster

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Authenticate to AWS via OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::437670317444:role/GitHubActionRole
          aws-region: ${{ env.AWS_REGION }}

      # 3. Login to Amazon ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Build & push FRONTEND image
      - name: Build and push frontend
        run: |
          FRONTEND_IMAGE=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/vault-app-repo-frontend:${{ github.sha }}
          docker build -t $FRONTEND_IMAGE ./src/public
          docker push $FRONTEND_IMAGE

      # 5. Build & push BACKEND image
      - name: Build and push backend
        run: |
          BACKEND_IMAGE=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/vault-app-repo-backend:${{ github.sha }}
          docker build -t $BACKEND_IMAGE ./src
          docker push $BACKEND_IMAGE

      # # 6. Configure kubectl for EKS
      # - name: Update kubeconfig
      #   run: |
      #     aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION

      # # 7. Apply ConfigMaps (non-sensitive config)
      # - name: Apply ConfigMaps
      #   run: |
      #     kubectl apply -f k8s/configmaps/

      # # 8. Apply Secrets from GitHub Secrets
      # - name: Apply backend secrets
      #   run: |
      #     kubectl create secret generic backend-secrets \
      #       --from-literal=DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
      #       --from-literal=JWT_SECRET=${{ secrets.JWT_SECRET }} \
      #       --dry-run=client -o yaml | kubectl apply -f -

      # # 9. Deploy new images to frontend and backend
      # - name: Deploy to EKS
      #   run: |
      #     kubectl set image deployment/frontend \
      #       frontend=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/vault-app-repo-frontend:${{ github.sha }}
      #     kubectl set image deployment/backend \
      #       backend=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/vault-app-repo-backend:${{ github.sha }}

      # # 10. Restart deployments to pick up secrets/config changes
      # - name: Restart deployments
      #   run: |
      #     kubectl rollout restart deployment/frontend
      #     kubectl rollout restart deployment/backend

      # # 11. Verify rollout status
      # - name: Verify rollout
      #   run: |
      #     kubectl rollout status deployment/frontend
      #     kubectl rollout status deployment/backend
